<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta http-equiv="origin-trial" content="**insert your token as provided in the the email here**"/>
    <script type="text/javascript">
(function () {
  function getChromeVersion () {
    var raw = navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);
    return raw ? parseInt(raw[2], 10) : false;
  }

  let blepayloadlen = 18;

  function handleSignature(event) {
    // check for any signature
    if (event.target.value.getUint8(0) == 2) {
      if (event.target.value.getFloat64(2) == 0.0) {
        //alert("DENIED");
        window.location = "denied.html";
      }
      else {
        //alert("Transaction succeeded!");
        window.location = "succeeded.html";
      }
    }
  }

  function enableButton(e) {
    document.getElementById('scan').disabled = !e;
  }

  let bledata = Uint8Array.from([
    0xad,0xfb,0xca,0xde,
    0x24,0xae,0x29,0x04,0x24,0x45,0x88,0x1a,0xea,0xf9,0x07,0x23,0x5b,0x06,0xe9,0x98,0x33,0x6d,0x41,0x07,
    0x35,0x3a,0x49,0x82,0x9b,0x60,0x2d,0x75,0x0d,0xef,0x62,0xb5,0x25,0xb0,0x85,0xb1,0xe0,0x87,0xc4,0xfb,0xed,0x57,0x3b,0x1f,0xec,0xdd,0xc7,0x97,0x81,0x8f,0xa2,0x2c,
    0x32,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x43,0x68,0x69,0x63,0x68,0x69,0x20,0x57,0x68,0x6f,0x6e,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x70,0x61,0x79,0x62,0x61,0x63,0x6b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x45,0x55,0x52,0x00]);

  function scan(event) {
    event.preventDefault();
    enableButton(false);

    // Overwrite data in blob with current input fields
    let amount = document.getElementById('amount').value * 100;
    let view = new DataView(bledata.buffer);
    view.setUint32(72, amount, true);
    let utf8 = new TextEncoder("utf-8");
    bledata.set(utf8.encode(document.getElementById('to_name').value+'\0'), 80);
    bledata.set(utf8.encode(document.getElementById('description').value+'\0'), 112);
    bledata.set(utf8.encode(document.getElementById('currency').value+'\0'), 132);

    let serviceUuid = '000026fd-f417-3ab3-6845-ba1516030b8c';
    navigator.bluetooth.requestDevice({ filters: [{ services: [serviceUuid] }] })
      .then(device => device.gatt.connect())
      .then(server => server.getPrimaryService(serviceUuid))
      .then(service =>
        service.getCharacteristic('000026ff-f417-3ab3-6845-ba1516030b8c')//read only
          .then(characteristic =>
            characteristic.startNotifications()
              .then(_ => characteristic.addEventListener('characteristicvaluechanged', handleSignature))
          )
          .then(_ => service.getCharacteristic('000026fe-f417-3ab3-6845-ba1516030b8c'))//write only
      )
      .then(characteristic => {
        var payload = new Uint8Array(blepayloadlen+2);
        var packetcount = Math.ceil(bledata.length / blepayloadlen);
        payload[1] = packetcount;
        var promise = new Promise((r,_) => r(0));
        while (packetcount-- > 0)
          promise = promise.then(id => {
            payload[0] = id;
            payload.set(bledata.slice(id*blepayloadlen, (id+1)*blepayloadlen), 2);
            return characteristic.writeValue(payload).then(_ => id + 1);
          });
        return promise;
      })
      .then(_ => {
        console.log('Done.');
        enableButton(true);
      })
      .catch(error => {
        console.log(error);
        enableButton(true);
      });
  }
  function init() {
    document.getElementById('scan').addEventListener("click", scan);
    if (getChromeVersion() >= 53)
      document.getElementById('chromeversion').style.display = 'none';
  }
  window.addEventListener("load", init);
})();
    </script>
    <title>FINCOVA</title><link rel="stylesheet" href="./assets/kendo.common.min.css"><link rel="stylesheet" href="./assets/kendo.bootstrap.min.css"><link rel="stylesheet" href="./assets/bootstrap.min.css"><link rel="stylesheet" href="./assets/style.css">
  </head>
  <body>
    <div align="center" class="div">
      <div id="chromeversion"><h4>This page requires Chrome v53 or above. <a href="https://www.google.com/chrome/browser/beta.html">Download here</a>.</h4></div>
      <div class="login well"><form id="bank-transfer-form" action="//waiting" method="post"><div class="form-group"><img src="/image/logo-transparent.png" width="40%" height="40%"></div><div class="form-group"><h4 style="text-align:center">Make a Bank Transfer</h4></div><div class="form-group"><label for="amount">Amount</label><input id="amount" type="number" name="amount" required="" data-required-msg="Amount is required" min="0.01" step="0.01" value="100" class="form-control"></div><div class="form-group"><label for="currency">Currency</label><input id="currency" type="text" name="currency" required="" data-required-msg="Currency is required" value="EUR" class="form-control"></div><div class="form-group"><label for="to_name">ReceiverName</label><input id="to_name" type="text" name="to_name" required="" data-required-msg="ReceiverName is required" value="Tracy Morgan" class="form-control"></div><div class="form-group"><label for="description">Description</label><input id="description" type="text" name="description" required="" data-required-msg="Description is required" value="Donation" class="form-control"></div><div class="form-group"><button id='scan' class="btn btn-default">SUBMIT</button></div></form></div></div>
  </body>
</html>

